name: Ubuntu Tailscale RDP

on:
  workflow_dispatch:

jobs:
  debug-rdp:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. RAM BOOST (Add 8GB Swap Memory)
      - name: Add 8GB Swap Space
        run: |
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          free -h # Show the new memory size in logs

      # 3. Install Desktop, Browser, and Office
      - name: Install Desktop & Apps
        run: |
          sudo apt-get update
          # Install XFCE (Desktop), Firefox, and LibreOffice
          sudo apt-get install -y xfce4 xfce4-goodies xrdp firefox libreoffice
          
          # Create Documents folder for Auto-Save
          mkdir -p /home/runner/Documents
          
          # Configure XRDP
          echo xfce4-session > ~/.xsession
          sudo service xrdp start

      # 4. Set Password (CHANGE "mypassword123" BELOW!)
      - name: Set User Password
        run: |
          echo "runner:mypassword123" | sudo chpasswd

      # 5. Connect to Tailscale (Fixed Version)
      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          version: 1.76.6

      # 6. Display IP and Keep Alive
      - name: Show IP and Keep Alive
        timeout-minutes: 360  # Stops automatically after 6 hours
        run: |
          echo "‚úÖ Tailscale is up!"
          echo "üöÄ RAM Boost Active: 15GB Total Memory"
          echo "üîå Connect via RDP to this IP:"
          tailscale ip -4
          
          echo "üìÇ IMPORTANT: Save your files in 'Documents' to keep them!"
          echo "‚è≥ Session active for 6 hours..."
          sleep 21600 

      # 7. SAVE WORK (Runs when time is up or you cancel)
      - name: Save Documents Folder
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: My-Saved-Work
          path: /home/runner/Documents
          
